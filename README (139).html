<hr>


<center>


<img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/23b9b236-746e-409c-8e86-30b4385e3b72/hr1-raypham.gif" alt="hr-line" width="781" height="22">


<p>NEXT</p>


</center>


<hr>


<h1 id="个人框架-db文件扩展">个人框架 db文件扩展</h1>
<h2 id="db文件说明">db文件说明</h2>
<p>db文件用于将nodejs中的sql代码统统提取出来，放到一个db文件中，以避免代码的混乱。</p>
<p>db文件中使用"##"表示注释，使用"#"表示名称。</p>
<p>db文件中，每个SQL语句之前必须有一个名称。</p>
<p>db文件中的SQL语句支持换行。</p>
<h2 id="特别说明">特别说明</h2>
<p>db文件属于是自定义文件，如果想在项目中使用，需要为db文件写一个解析器。</p>
<p>下面是JavaScript的一种简单实现方法。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="co">/**</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co"> * db文件解析器</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co"> * 此解析器用于解析db文件并将db文件中的SQL语句存放到全局变量sql中。</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co"> * 架设db文件所在目录的结构如下：</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co"> *      dbFiles</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co"> *          |   user.db</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co"> *          |   group.db</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co"> * 经过解析之后，sql变量结构如下：</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co"> *      {</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co"> *          user:{</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co"> *              //sql名称 =&gt; sql语句</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co"> *          },</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="co"> *          group:{</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="co"> *              //sql名称 =&gt; sql语句</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co"> *          }</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co"> *      }</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="co"> * db文件格式如下：</span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="co"> *      ## 注释</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="co"> *      # sql名称</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="co"> *      sql语句</span></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="co"> */</span></a>
<a class="sourceLine" id="cb1-22" title="22"></a>
<a class="sourceLine" id="cb1-23" title="23"></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;fs&#39;</span>)</a>
<a class="sourceLine" id="cb1-25" title="25"><span class="kw">const</span> path <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;path&#39;</span>)</a>
<a class="sourceLine" id="cb1-26" title="26"></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="co">//用于存放SQL语句</span></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="va">global</span>.<span class="at">sql</span> <span class="op">=</span> <span class="op">{};</span></a>
<a class="sourceLine" id="cb1-29" title="29"></a>
<a class="sourceLine" id="cb1-30" title="30"><span class="co">//转换SQL语句</span></a>
<a class="sourceLine" id="cb1-31" title="31"><span class="kw">function</span> <span class="at">parseSql</span>(content <span class="op">=</span> <span class="st">&#39;&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-32" title="32">    <span class="kw">let</span> obj <span class="op">=</span> <span class="op">{};</span></a>
<a class="sourceLine" id="cb1-33" title="33">    <span class="co">//去掉注释</span></a>
<a class="sourceLine" id="cb1-34" title="34">    content <span class="op">=</span> <span class="va">content</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">^</span><span class="ss">##</span><span class="sc">[\s\S]+?\n</span><span class="ss">/gim</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-35" title="35">    <span class="co">//以#号分割</span></a>
<a class="sourceLine" id="cb1-36" title="36">    <span class="va">content</span>.<span class="at">split</span>(<span class="ss">/#/gim</span>)</a>
<a class="sourceLine" id="cb1-37" title="37">        <span class="co">//去掉每个字符串前后的空白</span></a>
<a class="sourceLine" id="cb1-38" title="38">        .<span class="at">map</span>(str <span class="kw">=&gt;</span> <span class="va">str</span>.<span class="at">trim</span>())</a>
<a class="sourceLine" id="cb1-39" title="39">        <span class="co">//过滤空字符串</span></a>
<a class="sourceLine" id="cb1-40" title="40">        .<span class="at">filter</span>(str <span class="kw">=&gt;</span> <span class="op">!!</span>str)</a>
<a class="sourceLine" id="cb1-41" title="41">        <span class="co">//以换行分割每个字符串</span></a>
<a class="sourceLine" id="cb1-42" title="42">        .<span class="at">map</span>(str <span class="kw">=&gt;</span> <span class="va">str</span>.<span class="at">split</span>(<span class="ss">/</span><span class="sc">\n+</span><span class="ss">/</span>))</a>
<a class="sourceLine" id="cb1-43" title="43">        <span class="co">//组合成对象并返回</span></a>
<a class="sourceLine" id="cb1-44" title="44">        .<span class="at">forEach</span>(([key<span class="op">,</span> ...<span class="at">values</span>]) <span class="kw">=&gt;</span> obj[<span class="va">key</span>.<span class="at">trim</span>()] <span class="op">=</span> <span class="va">values</span>.<span class="at">join</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb1-45" title="45">    <span class="co">//返回转换结果</span></a>
<a class="sourceLine" id="cb1-46" title="46">    <span class="cf">return</span> obj<span class="op">;</span></a>
<a class="sourceLine" id="cb1-47" title="47"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-48" title="48"></a>
<a class="sourceLine" id="cb1-49" title="49"><span class="co">//将SQL文件内容进行解析，并将解析结果存放到全局。</span></a>
<a class="sourceLine" id="cb1-50" title="50"><span class="kw">function</span> <span class="at">makeSqlData</span>(filename<span class="op">,</span> content) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-51" title="51">    <span class="co">//去除后缀得到名称作为变量名</span></a>
<a class="sourceLine" id="cb1-52" title="52">    <span class="kw">let</span> [_<span class="op">,</span> name] <span class="op">=</span> <span class="va">filename</span>.<span class="at">split</span>(<span class="ss">/</span><span class="sc">^([\s\S]+?)</span><span class="ss">.db/</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-53" title="53">    <span class="co">//解析sql内容</span></a>
<a class="sourceLine" id="cb1-54" title="54">    <span class="va">global</span>.<span class="at">sql</span>[name] <span class="op">=</span> <span class="at">parseSql</span>(content <span class="op">+</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-55" title="55"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-56" title="56"></a>
<a class="sourceLine" id="cb1-57" title="57"><span class="co">//db文件加载器</span></a>
<a class="sourceLine" id="cb1-58" title="58"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="kw">function</span> <span class="at">loadDBFile</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-59" title="59">    <span class="co">//这里配置一下db文件所在的文件夹，该文件夹下的所有db文件都会被解析并存放到全局变量sql中。</span></a>
<a class="sourceLine" id="cb1-60" title="60">    <span class="kw">let</span> dbFilePath <span class="op">=</span> <span class="va">path</span>.<span class="at">join</span>(__dirname<span class="op">,</span> <span class="st">&#39;./../config/sql&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-61" title="61">    <span class="co">//读取文件列表</span></a>
<a class="sourceLine" id="cb1-62" title="62">    <span class="va">fs</span>.<span class="at">readdirSync</span>(dbFilePath).<span class="at">forEach</span>(file <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-63" title="63">        <span class="co">//如果不是以db结尾的文件则不进行处理</span></a>
<a class="sourceLine" id="cb1-64" title="64">        <span class="cf">if</span> (<span class="op">!</span><span class="ss">/.db</span><span class="sc">$</span><span class="ss">/</span>.<span class="at">test</span>(file)) <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-65" title="65">        <span class="co">//读取文件并处理</span></a>
<a class="sourceLine" id="cb1-66" title="66">        <span class="kw">let</span> filePath <span class="op">=</span> <span class="va">path</span>.<span class="at">join</span>(dbFilePath<span class="op">,</span> file)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-67" title="67">        <span class="kw">let</span> content <span class="op">=</span> <span class="va">fs</span>.<span class="at">readFileSync</span>(filePath)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-68" title="68">        <span class="co">//处理内容</span></a>
<a class="sourceLine" id="cb1-69" title="69">        <span class="at">makeSqlData</span>(file<span class="op">,</span> content)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-70" title="70">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb1-71" title="71"><span class="op">}</span></a></code></pre></div>
<h2 id="db文件格式如下">db文件格式如下</h2>
<pre><code>## 使用此语句可以添加一个用户到用户表中
# createUser
insert into `user` set ?

## 使用此语句可以修改用户信息
# updateUser
update `user` set ? where `id` = ?</code></pre>
